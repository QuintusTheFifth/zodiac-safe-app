import { Contract } from "ethers";
import { defaultProvider } from "../services/helpers";

const GNOSIS_GENERIC_PROXY_CONTRACT_BYTECODE =
  "0x608060405273ffffffffffffffffffffffffffffffffffffffff600054167fa619486e0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000f35b3660008037600080366000845af43d6000803e60008114156070573d6000fd5b3d6000f3fea265627a7a72315820d8a00dc4fe6bf675a9d7416fc2d00bb3433362aa8186b750f76c4027269667ff64736f6c634300050e0032";

const GNOSIS_GENERIC_PROXY_CONTRACT_ABI = [
  "function masterCopy() external view returns (address)",
];

const DELAY_MODULE_CONTRACT_BYTECODE =
  "0x608060405234801561001057600080fd5b50600436106101425760003560e01c80639b56d5be116100b8578063c66323e51161007c578063c66323e514610387578063dcafac09146103a5578063de8dd91d146103c3578063ebb2b4a2146103e1578063ee072baf146103fd578063f04505181461041957610142565b80639b56d5be146102f7578063a8ee49fe14610313578063a95f524614610343578063b19d47581461035f578063c34c08e51461036957610142565b8063427e232f1161010a578063427e232f14610225578063468721a71461025557806346ba230714610271578063605df59c1461028d578063610b5925146102ab5780636b0a4cf6146102c757610142565b806301209ce414610147578063258148cc14610177578063300c661f146101a7578063392e53cd146101d75780633aa76906146101f5575b600080fd5b610161600480360381019061015c9190611339565b610435565b60405161016e9190611aa0565b60405180910390f35b610191600480360381019061018c91906114d5565b61048b565b60405161019e9190611cb1565b60405180910390f35b6101c160048036038101906101bc91906113e2565b6104a3565b6040516101ce9190611abb565b60405180910390f35b6101df6104dc565b6040516101ec9190611aa0565b60405180910390f35b61020f600480360381019061020a91906114d5565b6104ef565b60405161021c9190611cb1565b60405180910390f35b61023f600480360381019061023a91906114d5565b61050c565b60405161024c9190611abb565b60405180910390f35b61026f600480360381019061026a9190611362565b610524565b005b61028b600480360381019061028691906114d5565b6106aa565b005b6102956107cb565b6040516102a29190611cb1565b60405180910390f35b6102c560048036038101906102c09190611339565b6107d1565b005b6102e160048036038101906102dc91906114d5565b610985565b6040516102ee9190611abb565b60405180910390f35b610311600480360381019061030c91906114d5565b6109a2565b005b61032d60048036038101906103289190611339565b610a89565b60405161033a9190611aa0565b60405180910390f35b61035d60048036038101906103589190611339565b610aa9565b005b610367610c5d565b005b610371610cd3565b60405161037e9190611ad6565b60405180910390f35b61038f610cf7565b60405161039c9190611cb1565b60405180910390f35b6103ad610cfd565b6040516103ba9190611cb1565b60405180910390f35b6103cb610d03565b6040516103d89190611cb1565b60405180910390f35b6103fb60048036038101906103f691906114d5565b610d09565b005b61041760048036038101906104129190611362565b610da1565b005b610433600480360381019061042e9190611486565b611074565b005b6000600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b60066020528060005260406000206000915090505481565b6000848484846040516020016104bc94939291906119ed565b604051602081830303815290604052805190602001209050949350505050565b600860009054906101000a900460ff1681565b600060066000838152602001908152602001600020549050919050565b60056020528060005260406000206000915090505481565b600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166105b0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105a790611bd1565b60405180910390fd5b610600858585858080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050846104a3565b600560006004548152602001908152602001600020819055504260066000600454815260200190815260200160002081905550600560006004548152602001908152602001600020546004547f4c8a9c748e976c17c2eb2c2bc50da76eac9cd90ff529f0fe900e0c10a179f0318787878787604051610683959493929190611a52565b60405180910390a36004600081548092919061069e90611ede565b91905055505050505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610738576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161072f90611c71565b60405180910390fd5b600354811161077c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077390611b71565b60405180910390fd5b6004548111156107c1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107b890611b91565b60405180910390fd5b8060038190555050565b60025481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461085f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161085690611c71565b60405180910390fd5b60011515600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514156108f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108ea90611c11565b60405180910390fd5b6001600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507fecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f84408160405161097a9190611a37565b60405180910390a150565b600060056000838152602001908152602001600020549050919050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610a30576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a2790611c71565b60405180910390fd5b6000811480610a405750603c8110155b610a7f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a7690611bb1565b60405180910390fd5b8060028190555050565b60076020528060005260406000206000915054906101000a900460ff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610b37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b2e90611c71565b60405180910390fd5b60001515600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415610bcb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bc290611b11565b60405180910390fd5b6000600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507faab4fa2b463f581b2b32cb3b7e3b704b9ce37cc209b5fb4d77e593ace405427681604051610c529190611a37565b60405180910390a150565b5b600060025414158015610c9f57504260025460015460066000600354815260200190815260200160002054610c939190611d65565b610c9d9190611d65565b105b8015610caf575060045460035411155b15610cd15760036000815480929190610cc790611ede565b9190505550610c5e565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035481565b60015481565b60045481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610d97576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d8e90611c71565b60405180910390fd5b8060018190555050565b60045460035410610de7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dde90611c31565b60405180910390fd5b6001546006600060035481526020019081526020016000205442610e0b9190611dbb565b1015610e4c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e4390611bf1565b60405180910390fd5b4260025460015460066000600354815260200190815260200160002054610e739190611d65565b610e7d9190611d65565b11610ebd576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610eb490611b31565b60405180910390fd5b610f0d858585858080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050846104a3565b6005600060035481526020019081526020016000205414610f63576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f5a90611b51565b60405180910390fd5b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663468721a786868686866040518663ffffffff1660e01b8152600401610fc4959493929190611a52565b602060405180830381600087803b158015610fde57600080fd5b505af1158015610ff2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611016919061145d565b611055576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161104c90611c91565b60405180910390fd5b6003600081548092919061106890611ede565b91905055505050505050565b600860009054906101000a900460ff16156110c4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110bb90611c51565b60405180910390fd5b60008211611107576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110fe90611af1565b60405180910390fd5b60008114806111175750603c8110155b611156576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161114d90611bb1565b60405180910390fd5b826000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600281905550816001819055506001600860006101000a81548160ff0219169083151502179055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3e0cc44510b6e74a9dc4238e8c6333297bcbb7ec294d752f3b6206419ee12b6760405160405180910390a3505050565b600061123161122c84611cfd565b611ccc565b90508281526020810184848401111561124957600080fd5b611254848285611e9c565b509392505050565b60008135905061126b81612033565b92915050565b6000815190506112808161204a565b92915050565b60008083601f84011261129857600080fd5b8235905067ffffffffffffffff8111156112b157600080fd5b6020830191508360018202830111156112c957600080fd5b9250929050565b600082601f8301126112e157600080fd5b81356112f184826020860161121e565b91505092915050565b60008135905061130981612061565b92915050565b60008135905061131e81612078565b92915050565b60008135905061133381612088565b92915050565b60006020828403121561134b57600080fd5b60006113598482850161125c565b91505092915050565b60008060008060006080868803121561137a57600080fd5b60006113888882890161125c565b955050602061139988828901611324565b945050604086013567ffffffffffffffff8111156113b657600080fd5b6113c288828901611286565b935093505060606113d58882890161130f565b9150509295509295909350565b600080600080608085870312156113f857600080fd5b60006114068782880161125c565b945050602061141787828801611324565b935050604085013567ffffffffffffffff81111561143457600080fd5b611440878288016112d0565b92505060606114518782880161130f565b91505092959194509250565b60006020828403121561146f57600080fd5b600061147d84828501611271565b91505092915050565b60008060006060848603121561149b57600080fd5b60006114a9868287016112fa565b93505060206114ba86828701611324565b92505060406114cb86828701611324565b9150509250925092565b6000602082840312156114e757600080fd5b60006114f584828501611324565b91505092915050565b61150781611def565b82525050565b61151e61151982611def565b611f27565b82525050565b61152d81611e01565b82525050565b61153c81611e0d565b82525050565b600061154e8385611d38565b935061155b838584611e9c565b61156483611ff4565b840190509392505050565b600061157a82611d2d565b6115848185611d49565b9350611594818560208601611eab565b80840191505092915050565b6115a981611e66565b82525050565b6115b881611e8a565b82525050565b6115cf6115ca82611e8a565b611f55565b82525050565b60006115e2602283611d54565b91507f436f6f6c646f776e206d75737420746f2062652067726561746572207468616e60008301527f20300000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000611648601783611d54565b91507f4d6f64756c6520616c72656164792064697361626c65640000000000000000006000830152602082019050919050565b6000611688601383611d54565b91507f5472616e73616374696f6e2065787069726564000000000000000000000000006000830152602082019050919050565b60006116c8601f83611d54565b91507f5472616e73616374696f6e2068617368657320646f206e6f74206d61746368006000830152602082019050919050565b6000611708602d83611d54565b91507f4e6577206e6f6e6365206d75737420626520686967686572207468616e20637560008301527f7272656e742074784e6f6e6365000000000000000000000000000000000000006020830152604082019050919050565b600061176e602083611d54565b91507f43616e6e6f7420626520686967686572207468616e2071756575654e6f6e63656000830152602082019050919050565b60006117ae602d83611d54565b91507f457870697261746974696f6e206d7573742062652030206f72206174206c656160008301527f7374203630207365636f6e6473000000000000000000000000000000000000006020830152604082019050919050565b6000611814601583611d54565b91507f4d6f64756c65206e6f7420617574686f72697a656400000000000000000000006000830152602082019050919050565b6000611854602083611d54565b91507f5472616e73616374696f6e206973207374696c6c20696e20636f6f6c646f776e6000830152602082019050919050565b6000611894601683611d54565b91507f4d6f64756c6520616c726561647920656e61626c6564000000000000000000006000830152602082019050919050565b60006118d4601a83611d54565b91507f5472616e73616374696f6e20717565756520697320656d7074790000000000006000830152602082019050919050565b6000611914601d83611d54565b91507f4d6f64756c6520697320616c726561647920696e697469616c697a65640000006000830152602082019050919050565b6000611954600e83611d54565b91507f4e6f7420617574686f72697a65640000000000000000000000000000000000006000830152602082019050919050565b6000611994601983611d54565b91507f4d6f64756c65207472616e73616374696f6e206661696c6564000000000000006000830152602082019050919050565b6119d081611e5c565b82525050565b6119e76119e282611e5c565b611f4b565b82525050565b60006119f9828761150d565b601482019150611a0982866119d6565b602082019150611a19828561156f565b9150611a2582846115be565b60018201915081905095945050505050565b6000602082019050611a4c60008301846114fe565b92915050565b6000608082019050611a6760008301886114fe565b611a7460208301876119c7565b8181036040830152611a87818587611542565b9050611a9660608301846115af565b9695505050505050565b6000602082019050611ab56000830184611524565b92915050565b6000602082019050611ad06000830184611533565b92915050565b6000602082019050611aeb60008301846115a0565b92915050565b60006020820190508181036000830152611b0a816115d5565b9050919050565b60006020820190508181036000830152611b2a8161163b565b9050919050565b60006020820190508181036000830152611b4a8161167b565b9050919050565b60006020820190508181036000830152611b6a816116bb565b9050919050565b60006020820190508181036000830152611b8a816116fb565b9050919050565b60006020820190508181036000830152611baa81611761565b9050919050565b60006020820190508181036000830152611bca816117a1565b9050919050565b60006020820190508181036000830152611bea81611807565b9050919050565b60006020820190508181036000830152611c0a81611847565b9050919050565b60006020820190508181036000830152611c2a81611887565b9050919050565b60006020820190508181036000830152611c4a816118c7565b9050919050565b60006020820190508181036000830152611c6a81611907565b9050919050565b60006020820190508181036000830152611c8a81611947565b9050919050565b60006020820190508181036000830152611caa81611987565b9050919050565b6000602082019050611cc660008301846119c7565b92915050565b6000604051905081810181811067ffffffffffffffff82111715611cf357611cf2611fc5565b5b8060405250919050565b600067ffffffffffffffff821115611d1857611d17611fc5565b5b601f19601f8301169050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b6000611d7082611e5c565b9150611d7b83611e5c565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115611db057611daf611f67565b5b828201905092915050565b6000611dc682611e5c565b9150611dd183611e5c565b925082821015611de457611de3611f67565b5b828203905092915050565b6000611dfa82611e3c565b9050919050565b60008115159050919050565b6000819050919050565b6000611e2282611def565b9050919050565b6000819050611e378261201f565b919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000611e7182611e78565b9050919050565b6000611e8382611e3c565b9050919050565b6000611e9582611e29565b9050919050565b82818337600083830152505050565b60005b83811015611ec9578082015181840152602081019050611eae565b83811115611ed8576000848401525b50505050565b6000611ee982611e5c565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415611f1c57611f1b611f67565b5b600182019050919050565b6000611f3282611f39565b9050919050565b6000611f4482612012565b9050919050565b6000819050919050565b6000611f6082612005565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b60008160f81b9050919050565b60008160601b9050919050565b600281106120305761202f611f96565b5b50565b61203c81611def565b811461204757600080fd5b50565b61205381611e01565b811461205e57600080fd5b50565b61206a81611e17565b811461207557600080fd5b50565b6002811061208557600080fd5b50565b61209181611e5c565b811461209c57600080fd5b5056fea264697066735822122012da0c69d353ad7360914462d28f25077b7205182200e7230e7ccb32786672b664736f6c63430008000033";

export function isGnosisGenericProxy(bytecode: string) {
  return bytecode.toLowerCase() === GNOSIS_GENERIC_PROXY_CONTRACT_BYTECODE;
}

export function isDelayModuleBytecode(bytecode: string) {
  return bytecode.toLowerCase() === DELAY_MODULE_CONTRACT_BYTECODE;
}

export function isGenericProxy(bytecode: string) {
  if (bytecode.length !== 92) return false;
  return (
    bytecode.startsWith("0x363d3d373d3d3d363d73") &&
    bytecode.endsWith("5af43d82803e903d91602b57fd5bf3")
  );
}

export function getGenericProxyMaster(bytecode: string) {
  return "0x" + bytecode.substr(22, 40);
}

export async function getProxyMaster(address: string) {
  const contract = new Contract(
    address,
    GNOSIS_GENERIC_PROXY_CONTRACT_ABI,
    defaultProvider
  );

  const [masterAddress] = await contract.functions.masterCopy();

  return masterAddress;
}
